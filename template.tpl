___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Elevar Monitoring Core Tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Makes sure no tag or variable error goes unnoticed.\n\nThe Core Tag sends errors that happen in other Elevar Monitoring Tags and Elevar Monitoring Variables to the Elevar dashboard.",
  "categories": ["UTILITY", "ANALYTICS", "TAG_MANAGEMENT"],
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "debugMode",
    "displayName": "Debug Mode Variable",
    "simpleValueType": true,
    "defaultValue": "{{Debug Mode}}",
    "help": "The \u003cstrong\u003eGTM Debug Mode Variable\u003c/strong\u003e is used to prevent the tag template from sending errors when in Preview Mode."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const addEventCallback = require("addEventCallback");
const copyFromWindow = require("copyFromWindow");
const setInWindow = require("setInWindow");
const sendPixel = require("sendPixel");
const encodeUriComponent = require("encodeUriComponent");
const getUrl = require("getUrl");

/**
 * This is required even though it wouldn't be used here
 * because the tests fail without it.
 */
const log = require("logToConsole");

const VALIDATION_ERRORS = "elevar_gtm_errors";
const TAG_INFO = "elevar_gtm_tag_info";
const DATA_LAYER = "dataLayer";
const PAGE_URL = getUrl();

const getEventName = (eventId, dataLayer) => {
  return dataLayer.reduce((item, curr) => {
    if (!item && curr["gtm.uniqueEventId"] === eventId) {
      return curr.event;
    }
    return item;
  }, false);
};

/**
* This function gets the tag information if it exists for the event & variable combo
* 
* @param tags: Array of tag information that have fired since the last monitoring pixel was sent
* @param eventId: The id of the event the current error occurred on
* @param variableName: The GTM name of the variable that errored
*/
const getTagWithVariable = (tags, eventId, variableName) => {
  if (!tags) return [];
  return tags
    .filter(tag => tag.eventId === eventId)
    .filter(
      tag =>
        tag.variables &&
        tag.variables.length &&
        tag.variables.indexOf(variableName) !== -1
    );
};

const joinKey = (key) => (array) => {
	if (!array) return [];
  	return array
  		.map(tag => tag[key])
  		.join(",");
};

const getChannels = joinKey('channel');
const getTagNames = joinKey('tagName');

// Fires after all tags for the trigger have completed
addEventCallback(function(containerId, _eventData) {
  const dataLayer = copyFromWindow(DATA_LAYER);
  const errors = copyFromWindow(VALIDATION_ERRORS);
  const tagInfo = copyFromWindow(TAG_INFO);

  // This removes the data from window after they have been read
  setInWindow(VALIDATION_ERRORS, [], true);
  setInWindow(TAG_INFO, [], true);

  // Send Pixel if there are errors
  if (errors && errors.length > 0) {
    errors.forEach((errorEvent, index) => {
      const eventName = getEventName(errorEvent.eventId, dataLayer);
      const tagsUsed = getTagWithVariable(
        tagInfo,
        errorEvent.eventId,
        errorEvent.variableName
      );
      const channels = getChannels(tagsUsed);
      const tagNames = getTagNames(tagsUsed);

      let url = "https://monitoring.getelevar.com/track.gif?ctid=" +
          containerId +
          "&idx=" +
          index +
          "&event_name=" +
          encodeUriComponent(eventName) +
          "&variable_name=" +
          encodeUriComponent(errorEvent.variableName) +
          "&channels=" +
          encodeUriComponent(channels) +
          "&tag_names=" +
          encodeUriComponent(tagNames) +
          "&dlKey=" +
          errorEvent.dataLayerKey +
          "&dlValue=" +
          encodeUriComponent(errorEvent.error.value) +
          "&cond=" +
          errorEvent.error.condition +
          "&condValue=" +
          encodeUriComponent(errorEvent.error.conditionValue) +
          "&url=" +
          encodeUriComponent(PAGE_URL);

      log("pixel url = ", url);
      if (!data.debugMode) {
        sendPixel(url);
      }
    });
  }
});

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "elevar_gtm_errors"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "elevar_gtm_tag_info"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://monitoring.getelevar.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: TEST UTIL // getQueryParams
  code: |-
    assertThat(
      getQueryParams(
        'https://test.com/test_url?param=value&event_name=test_event',
        'event_name'
      )
    ).isEqualTo('test_event');

    assertThat(
      getQueryParams(
        'https://test.com/test_url?param=value&event_name=test_event',
        'param'
      )
    ).isEqualTo('value');

    assertThat(
      getQueryParams(
        'https://test.com/test_url?param=value&event_name=test_event',
        'not_real'
      )
    ).isEqualTo(undefined);
- name: PIXEL // Multiple Errors and Tag data
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalled();
    assertThat(sentUrls.length === 3).isTrue();

    // -----------------------------------------------------------------

    assertThat(getQueryParams(sentUrls[0], 'ctid')).isEqualTo('GTM-12345678');
    assertThat(getQueryParams(sentUrls[0], 'idx')).isEqualTo('0');
    assertThat(getQueryParams(sentUrls[0], 'event_name')).isEqualTo('gtm.js');
    assertThat(getQueryParams(sentUrls[0], 'variable_name')).isEqualTo('dlv%20-%20Variable%201');
    assertThat(getQueryParams(sentUrls[0], 'channels')).isEqualTo('facebook');
    assertThat(getQueryParams(sentUrls[0], 'tag_names')).isEqualTo('Facebook%20-%20Initiate%20Checkout');
    assertThat(getQueryParams(sentUrls[0], 'dlKey')).isEqualTo('key1');
    assertThat(getQueryParams(sentUrls[0], 'dlValue')).isEqualTo('val1');
    assertThat(getQueryParams(sentUrls[0], 'cond')).isEqualTo('condition1');
    assertThat(getQueryParams(sentUrls[0], 'condValue')).isEqualTo('conditionValue1');

    // -----------------------------------------------------------------

    assertThat(getQueryParams(sentUrls[1], 'ctid')).isEqualTo('GTM-12345678');
    assertThat(getQueryParams(sentUrls[1], 'idx')).isEqualTo('1');
    assertThat(getQueryParams(sentUrls[1], 'channels')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[1], 'event_name')).isEqualTo('gtm.load');
    assertThat(getQueryParams(sentUrls[1], 'variable_name')).isEqualTo('dlv%20-%20Variable%202');
    assertThat(getQueryParams(sentUrls[1], 'tag_names')).isEqualTo('Facebook%20-%20Add%20To%20Cart');
    assertThat(getQueryParams(sentUrls[1], 'dlKey')).isEqualTo('key2');
    assertThat(getQueryParams(sentUrls[1], 'dlValue')).isEqualTo('val2');
    assertThat(getQueryParams(sentUrls[1], 'cond')).isEqualTo('condition2');
    assertThat(getQueryParams(sentUrls[1], 'condValue')).isEqualTo('conditionValue2');

    // -----------------------------------------------------------------

    assertThat(getQueryParams(sentUrls[2], 'ctid')).isEqualTo('GTM-12345678');
    assertThat(getQueryParams(sentUrls[2], 'idx')).isEqualTo('2');
    assertThat(getQueryParams(sentUrls[2], 'channels')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[2], 'event_name')).isEqualTo('gtm.load');
    assertThat(getQueryParams(sentUrls[2], 'variable_name')).isEqualTo('dlv%20-%20Variable%203');
    assertThat(getQueryParams(sentUrls[2], 'tag_names')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[2], 'dlKey')).isEqualTo('key3');
    assertThat(getQueryParams(sentUrls[2], 'dlValue')).isEqualTo('val3');
    assertThat(getQueryParams(sentUrls[2], 'cond')).isEqualTo('condition3');
    assertThat(getQueryParams(sentUrls[2], 'condValue')).isEqualTo('conditionValue3');
- name: PIXEL // No errors
  code: |-
    elevar_gtm_errors = undefined;

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
    assertThat(sentUrls.length === 0).isTrue();
- name: PIXEL // No tags data match
  code: |-
    elevar_gtm_errors = [{
      eventId: 4,
      dataLayerKey: 'key',
      variableName: 'dlv - Variable 1',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }];

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(sentUrls.length === 1).isTrue();
    assertThat(getQueryParams(sentUrls[0], 'tag_names')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[0], 'channels')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[0], 'variable_name')).isEqualTo('dlv%20-%20Variable%201');
- name: PIXEL // Erroring variable in multiple tags
  code: "elevar_gtm_errors = [{\n  eventId: 7,\n  dataLayerKey: 'key',\n  variableName:\
    \ 'dlv - Variable 1',\n  error: {\n    message: 'message',\n    value: 'val',\n\
    \    condition: 'condition',\n    conditionValue: 'conditionValue'\n  }\n}];\n\
    \nelevar_gtm_tag_info = [{\n\teventId: 7,\n  \tchannel: 'facebook',\n\ttagName:\
    \ \"Facebook - Initiate Checkout\",\n  \tvariables: ['dlv - Variable 1', 'dlv\
    \ - Variable 2'],\n}, {\n\teventId: 7,\n    channel: 'facebook',\n  \ttagName:\
    \ \"Facebook - Conversion\",\n   \tvariables: ['dlv - Variable 1', 'dlv - Variable\
    \ 2'],\n}];\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertThat(getQueryParams(sentUrls[0],\
    \ 'channels')).isEqualTo('facebook%2Cfacebook');\nassertThat(\n  getQueryParams(sentUrls[0],\
    \ 'tag_names')\n).isEqualTo('Facebook%20-%20Initiate%20Checkout%2CFacebook%20-%20Conversion');\n\
    assertThat(sentUrls.length === 1).isTrue();"
- name: PIXEL // Missing variable name from error
  code: "elevar_gtm_errors = [{\n  eventId: 7,\n  dataLayerKey: 'key',\n  variableName:\
    \ '',\n  error: {\n    message: 'message',\n    value: 'val',\n    condition:\
    \ 'condition',\n    conditionValue: 'conditionValue'\n  }\n}];\n\nelevar_gtm_tag_info\
    \ = [{\n\teventId: 7,\n\ttagName: \"Facebook - Initiate Checkout\",\n  \tvariables:\
    \ ['dlv - Variable 1', 'dlv - Variable 2'],\n}, {\n\teventId: 7,\n  \ttagName:\
    \ \"Facebook - Conversion\",\n   \tvariables: ['dlv - Variable 1', 'dlv - Variable\
    \ 2'],\n}];\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertThat(getQueryParams(sentUrls[0],\
    \ 'tag_names')).isEqualTo('');\nassertThat(getQueryParams(sentUrls[0], 'variable_name')).isEqualTo('');\n\
    assertThat(getQueryParams(sentUrls[0], 'dlKey')).isEqualTo('key');\nassertThat(getQueryParams(sentUrls[0],\
    \ 'dlValue')).isEqualTo('val');\nassertThat(getQueryParams(sentUrls[0], 'cond')).isEqualTo('condition');\n\
    assertThat(getQueryParams(sentUrls[0], 'condValue')).isEqualTo('conditionValue');\n\
    assertThat(sentUrls.length === 1).isTrue();"
- name: PIXEL // No tag info in window
  code: |-
    elevar_gtm_errors = [{
      eventId: 7,
      dataLayerKey: 'key',
      variableName: 'variable name',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }];

    elevar_gtm_tag_info = undefined;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(sentUrls.length === 1).isTrue();
    assertThat(getQueryParams(sentUrls[0], 'tag_names')).isEqualTo('');
    assertThat(getQueryParams(sentUrls[0], 'variable_name')).isEqualTo('variable%20name');
    assertThat(getQueryParams(sentUrls[0], 'dlKey')).isEqualTo('key');
    assertThat(getQueryParams(sentUrls[0], 'dlValue')).isEqualTo('val');
    assertThat(getQueryParams(sentUrls[0], 'cond')).isEqualTo('condition');
    assertThat(getQueryParams(sentUrls[0], 'condValue')).isEqualTo('conditionValue');
- name: GENERAL // Debug mode
  code: |-
    mockData.debugMode = true;

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
    assertThat(sentUrls.length === 0).isTrue();
- name: PIXEL // Channel is sent per tag
  code: "elevar_gtm_errors = [{\n  eventId: 7,\n  dataLayerKey: 'key',\n  variableName:\
    \ 'dlv - Variable 1',\n  error: {\n    message: 'message',\n    value: 'val',\n\
    \    condition: 'condition',\n    conditionValue: 'conditionValue'\n  }\n}];\n\
    \nelevar_gtm_tag_info = [{\n\teventId: 7,\n  \tchannel: 'facebook',\n\ttagName:\
    \ \"Facebook - Initiate Checkout\",\n  \tvariables: ['dlv - Variable 1', 'dlv\
    \ - Variable 2'],\n}, {\n\teventId: 7,\n    channel: '',\n  \ttagName: \"Klaviyo\
    \ - Conversion\",\n   \tvariables: ['dlv - Variable 1', 'dlv - Variable 2'],\n\
    }, {\n\teventId: 7,\n    channel: 'snapchat',\n  \ttagName: \"Snapchat - Conversion\"\
    ,\n   \tvariables: ['dlv - Variable 1'],\n}, {\n\teventId: 7,\n    channel: 'facebook',\n\
    \  \ttagName: \"Facebook - Conversion\",\n   \tvariables: ['dlv - Variable 1'],\n\
    }];\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertThat(getQueryParams(sentUrls[0], 'channels')).isEqualTo('facebook%2C%2Csnapchat%2Cfacebook');\n\
    assertThat(sentUrls.length === 1).isTrue();"
setup: "const log = require(\"logToConsole\");\n\nconst sentUrls = [];\n\nlet mockData\
  \ = {\n  customDataLayer: false,\n  dataLayerName: \"dataLayer\",\n  debugMode:\
  \ false\n};\n\nlet dataLayer = [\n  {\n    event: \"gtm.dom\",\n    \"gtm.uniqueEventId\"\
  : 3\n  },\n  {\n    \"gtm.start\": 1578412516211,\n    event: \"gtm.js\",\n    \"\
  gtm.uniqueEventId\": 4\n  },\n  {\n    \"gtm.start\": 1578412516344,\n    event:\
  \ \"gtm.js\",\n    \"gtm.uniqueEventId\": 7\n  },\n  {\n    event: \"gtm.load\"\
  ,\n    \"gtm.uniqueEventId\": 11\n  }\n];\n\nlet elevar_gtm_errors = [\n  {\n  \
  \  eventId: 7,\n    dataLayerKey: \"key1\",\n    variableName: \"dlv - Variable\
  \ 1\",\n    error: {\n      message: \"message1\",\n      value: \"val1\",\n   \
  \   condition: \"condition1\",\n      conditionValue: \"conditionValue1\"\n    }\n\
  \  },\n  {\n    eventId: 11,\n    dataLayerKey: \"key2\",\n    variableName: \"\
  dlv - Variable 2\",\n    error: {\n      message: \"message2\",\n      value: \"\
  val2\",\n      condition: \"condition2\",\n      conditionValue: \"conditionValue2\"\
  \n    }\n  },\n  {\n    eventId: 11,\n    dataLayerKey: \"key3\",\n    variableName:\
  \ \"dlv - Variable 3\",\n    error: {\n      message: \"message3\",\n      value:\
  \ \"val3\",\n      condition: \"condition3\",\n      conditionValue: \"conditionValue3\"\
  \n    }\n  }\n];\n\nlet elevar_gtm_tag_info = [\n  {\n    eventId: 7,\n    channel:\
  \ \"facebook\",\n    tagName: \"Facebook - Initiate Checkout\",\n    variables:\
  \ [\"dlv - Variable 1\", \"dlv - Variable 2\"]\n  },\n  {\n    eventId: 11,\n  \
  \  tagName: \"Facebook - Add To Cart\",\n    variables: [\"dlv - Variable 2\"]\n\
  \  }\n];\n\nmock(\"copyFromWindow\", variableName => {\n  switch (variableName)\
  \ {\n    case \"elevar_gtm_errors\":\n      return elevar_gtm_errors;\n    case\
  \ \"elevar_gtm_tag_info\":\n      return elevar_gtm_tag_info;\n    case mockData.dataLayerName:\n\
  \      return dataLayer;\n    default:\n      log(\"no object in mock window for\
  \ variableName: \", variableName);\n  }\n});\n\nmock(\"addEventCallback\", callback\
  \ => {\n  callback(\"GTM-12345678\");\n});\n\nmock(\"sendPixel\", url => {\n  sentUrls.push(url);\n\
  });\n\n\nmock(\"getUrl\", () => {\n\treturn 'https://test.example.com/test-page/item?id=123&s=testing';\n\
  });\n\n/* ------------ TEST UTILITY FUNCTIONS ------------ */\n\nconst getQueryParams\
  \ = (url, key) => {\n  const param = url\n    .split(\"?\")[1]\n    .split(\"&\"\
  )\n    .map(paramString => {\n      const keyAndVal = paramString.split(\"=\");\n\
  \      return { key: keyAndVal[0], val: keyAndVal[1] };\n    })\n    .filter(param\
  \ => param.key === key)[0];\n  if (!param) return undefined;\n  return param.val;\n\
  };"


___NOTES___

Created on 04/12/2019, 13:17:50


