___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Elevar Monitoring Core Tag",
  "brand": {
    "id": "github.com_getelevar",
    "displayName": "getelevar",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Makes sure no tag or variable error goes unnoticed.\n\nThe Core Tag logs errors that happen in other Elevar Monitoring Tags and Elevar Monitoring Variables to the devtools console.",
  "categories": [
    "UTILITY",
    "ANALYTICS",
    "TAG_MANAGEMENT"
  ],
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "debugMode",
    "displayName": "Debug Mode Variable",
    "simpleValueType": true,
    "help": "The \u003cstrong\u003eDebug Mode Variable\u003c/strong\u003e is used to test if variables are not correct for tags."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const addEventCallback = require("addEventCallback");
const copyFromWindow = require("copyFromWindow");
const setInWindow = require("setInWindow");
const log = require("logToConsole");

const VALIDATION_ERRORS = "elevar_gtm_errors";
const TAG_INFO = "elevar_gtm_tag_info";
const DATA_LAYER = "dataLayer";

const getEventName = (eventId, dataLayer) => {
  const items = dataLayer.filter(item => 
    item["gtm.uniqueEventId"] === eventId
  );
  return items.length > 0 ? items[0].event : false;
};

/**
 * This function gets the tag information if it exists for the event & variable combo
 *
 * @param tags: Array of tag information that have fired since the last monitoring pixel was sent
 * @param eventId: The id of the event the current error occurred on
 * @param variableName: The GTM name of the variable that errored
 */
const getTagWithVariable = (tags, eventId, variableName) => {
  if (!tags) return [];
  return tags
    .filter((tag) => tag.eventId === eventId)
    .filter(
      (tag) =>
        tag.variables &&
        tag.variables.length &&
        tag.variables.indexOf(variableName) !== -1
    );
};


const logTags = (eventName, errorEvent, tags) => {
  const logTag = (tag) => {
    const baseErrorMessage = "Elevar DataLayer Debugger: Error for " + (eventName ? eventName : "No event given") + ". Variable " + errorEvent.variableName;
    const errorValueMessage = "DataLayer key is " + errorEvent.dataLayerKey + " value provided was: " + errorEvent.error.value + " " + errorEvent.error.condition + " " + errorEvent.error.conditionValue;
    const errorTagsMessage = tag && tag.tagName ? "Tags: " + tag.tagName : ""; 
    if (data.debugMode) {
      log(baseErrorMessage + " " + errorValueMessage + " " + errorTagsMessage);
    }
  };

  if (tags.length > 0) {
    tags.forEach(logTag);
  } else {
    logTag(undefined);
  }
};

// Fires after all tags for the trigger have completed
addEventCallback(function (_, _eventData) {
  const dataLayer = copyFromWindow(DATA_LAYER);
  const errors = copyFromWindow(VALIDATION_ERRORS);
  const tagInfo = copyFromWindow(TAG_INFO);

  // This removes the data from window after they have been read
  setInWindow(VALIDATION_ERRORS, [], true);
  setInWindow(TAG_INFO, [], true);

  // Send Pixel if there are errors
  if (errors && errors.length > 0) {
    errors.forEach((errorEvent, _) => {
      const eventName = errorEvent.eventName ?
            errorEvent.eventName :
            getEventName(errorEvent.eventId, dataLayer);

      const tagsUsed = getTagWithVariable(
        tagInfo,
        errorEvent.eventId,
        errorEvent.variableName
      );
      
      logTags(eventName ? eventName : '', errorEvent, tagsUsed);
    });
  }
});

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "elevar_gtm_errors"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "elevar_gtm_tag_info"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: PIXEL // Multiple Errors and Tag data
  code: |-
    dataLayer = [
      {
        event: "gtm.dom",
        "gtm.uniqueEventId": 3
      },
      {
        "gtm.start": 1578412516344,
        event: "gtm.js",
        "gtm.uniqueEventId": 7
      },
      {
        event: "gtm.load",
        "gtm.uniqueEventId": 11
      }
    ];

    elevar_gtm_errors = [
      {
        eventId: 7,
        dataLayerKey: "key1",
        variableName: "dlv - Variable 1",
        error: {
          message: "message1",
          value: "val1",
          condition: "condition1",
          conditionValue: "conditionValue1"
        }
      },
      {
        eventId: 11,
        dataLayerKey: "key2",
        variableName: "dlv - Variable 2",
        error: {
          message: "message2",
          value: "val2",
          condition: "condition2",
          conditionValue: "conditionValue2"
        }
      },
      {
        eventId: 11,
        dataLayerKey: "key3",
        variableName: "dlv - Variable 3",
        error: {
          message: "message3",
          value: "val3",
          condition: "condition3",
          conditionValue: "conditionValue3"
        }
      }
    ];

    elevar_gtm_tag_info = [
      {
        eventId: 7,
        channel: "facebook",
        tagName: "Facebook - Initiate Checkout",
        variables: ["dlv - Variable 1", "dlv - Variable 2"]
      },
      {
        eventId: 11,
        tagName: "Facebook - Add To Cart",
        variables: ["dlv - Variable 2"]
      }
    ];

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('copyFromWindow').wasCalled();
    assertThat(logs).hasLength(3);

    // -----------------------------------------------------------------


    assertThat(logs[0], 'event_name').contains('gtm.js');
    assertThat(logs[0], 'variable_name').contains(elevar_gtm_errors[0].variableName);
    assertThat(logs[0], 'tag_names').contains(elevar_gtm_tag_info[0].tagName);
    assertThat(logs[0], 'dlKey').contains('key1');
    assertThat(logs[0], 'dlValue').contains('val1');
    assertThat(logs[0], 'cond').contains('condition1');
    assertThat(logs[0], 'condValue').contains('conditionValue1');

    // -----------------------------------------------------------------

    assertThat(logs[1], 'event_name').contains('gtm.load');
    assertThat(logs[1], 'variable_name').contains(elevar_gtm_errors[1].variableName);
    assertThat(logs[1], 'tag_names').contains(elevar_gtm_tag_info[1].tagName);
    assertThat(logs[1], 'dlKey').contains('key2');
    assertThat(logs[1], 'dlValue').contains('val2');
    assertThat(logs[1], 'cond').contains('condition2');
    assertThat(logs[1], 'condValue').contains('conditionValue2');


    // -----------------------------------------------------------------

    assertThat(logs[2], 'event_name').contains('gtm.load');
    assertThat(logs[2], 'variable_name').contains(elevar_gtm_errors[2].variableName);
    assertThat(logs[2], 'tag_names').contains('');
    assertThat(logs[2], 'dlKey').contains('key3');
    assertThat(logs[2], 'dlValue').contains('val3');
    assertThat(logs[2], 'cond').contains('condition3');
    assertThat(logs[2], 'condValue').contains('conditionValue3');
- name: PIXEL // No errors
  code: |-
    elevar_gtm_errors = undefined;

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
    assertThat(logs.length === 0).isTrue();
- name: PIXEL // No event matching
  code: |
    elevar_gtm_errors = [{
      eventId: 100,
      dataLayerKey: 'key',
      variableName: 'dlv - Variable 1',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }];

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains("No event given");
- name: PIXEL // No tags data match
  code: |-
    elevar_gtm_errors = [{
      eventId: 4,
      dataLayerKey: 'key',
      variableName: 'dlv - Variable 1',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }];

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains(elevar_gtm_errors[0].variableName);
- name: PIXEL // Erroring variable in multiple tags
  code: "elevar_gtm_errors = [{\n    eventId: 7,\n    dataLayerKey: 'key.item.0.id',\n\
    \    variableName: 'dlv - Variable 1',\n    error: {\n      message: 'message',\n\
    \      value: 'val',\n      condition: 'condition',\n      conditionValue: 'conditionValue'\n\
    \    }\n  }];\n  \n  elevar_gtm_tag_info = [{\n      eventId: 7,\n        channel:\
    \ 'facebook',\n      tagName: \"Facebook - Initiate Checkout\",\n        variables:\
    \ ['dlv - Variable 1', 'dlv - Variable 2'],\n  }, {\n      eventId: 7,\n     \
    \ channel: 'facebook',\n        tagName: \"Facebook - Conversion\",\n        \
    \ variables: ['dlv - Variable 1', 'dlv - Variable 2'],\n  }];\n  \n  // Call runCode\
    \ to run the template's code.\n  runCode(mockData);\n  \n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertThat(logs).hasLength(2);\n  assertThat(logs[0])\n  .contains(elevar_gtm_tag_info[0].tagName);\n\
    \  assertThat(logs[1])\n  .contains(elevar_gtm_tag_info[1].tagName);"
- name: PIXEL // No tag info in window
  code: "elevar_gtm_errors = [{\n    eventId: 7,\n    dataLayerKey: 'key',\n    variableName:\
    \ 'variable name',\n    error: {\n      message: 'message',\n      value: 'val',\n\
    \      condition: 'condition',\n      conditionValue: 'conditionValue'\n    }\n\
    \  }];\n  \n  elevar_gtm_tag_info = undefined;\n  \n  // Call runCode to run the\
    \ template's code.\n  runCode(mockData);\n  \n  // Verify that the tag finished\
    \ successfully.\n  assertApi('gtmOnSuccess').wasCalled();\n  assertThat(logs.length\
    \ === 1).isTrue();\n  assertThat(logs[0]).contains('');\n  assertThat(logs[0]).contains(elevar_gtm_errors[0].variableName);\n\
    \  assertThat(logs[0]).contains('key');\n  assertThat(logs[0]).contains('val');\n\
    \  assertThat(logs[0]).contains('condition');\n  assertThat(logs[0]).contains('conditionValue');"
- name: PIXEL // Variable error contains undefined
  code: |-
    elevar_gtm_errors = [{
      eventId: 7,
      dataLayerKey: 'key',
      variableName: 'variable name',
      error: {
        condition: 'condition',
      }
    }];

    elevar_gtm_tag_info = undefined;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains("undefined");
- name: PIXEL // Variable error contains object
  code: |-
    elevar_gtm_errors = [{
      eventId: 7,
      dataLayerKey: 'key',
      variableName: 'variable name',
      error: {
        message: 'dlvkey=[Object object] condition conditionValue',
        value: { object: 'ok' },
        condition: 'condition',
        conditionValue: false
      }
    }];

    elevar_gtm_tag_info = undefined;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains("[object Object]");
- name: PIXEL // Variable error contains array
  code: |-
    elevar_gtm_errors = [{
      eventId: 7,
      dataLayerKey: 'key',
      variableName: 'variable name',
      error: {
        message: 'dlvkey=arr condition conditionValue',
        value: ['cool', 'ok'],
        condition: 'condition',
        conditionValue: false
      }
    }];

    elevar_gtm_tag_info = undefined;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains("cool,ok");
- name: PIXEL // Variable name is undefined
  code: |-
    elevar_gtm_errors = [{
      eventId: 7,
      dataLayerKey: 'key',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'condVal'
      }
    }];

    elevar_gtm_tag_info = undefined;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs.length === 1).isTrue();
    assertThat(logs[0]).contains("undefined");
- name: PIXEL // One pixel per tag
  code: "elevar_gtm_errors = [{\n    eventId: 7,\n    dataLayerKey: 'key',\n    variableName:\
    \ 'dlv - Variable 1',\n    error: {\n      message: 'message',\n      value: 'val',\n\
    \      condition: 'condition',\n      conditionValue: 'conditionValue'\n    }\n\
    \  }, {\n    eventId: 7,\n    dataLayerKey: 'key2',\n    variableName: 'dlv -\
    \ Variable 2',\n    error: {\n      message: 'message',\n      value: 'val',\n\
    \      condition: 'condition',\n      conditionValue: 'conditionValue'\n    }\n\
    \  }, {\n    eventId: 7,\n    dataLayerKey: 'key3',\n    variableName: 'dlv -\
    \ Variable 3',\n    error: {\n      message: 'message',\n      value: 'val',\n\
    \      condition: 'condition',\n      conditionValue: 'conditionValue'\n    }\n\
    \  }];\n  \n  elevar_gtm_tag_info = [{\n      eventId: 7,\n        channel: 'facebook',\n\
    \      tagName: \"Facebook - Initiate Checkout\",\n        variables: ['dlv -\
    \ Variable 1', 'dlv - Variable 2'],\n  }, {\n      eventId: 7,\n        tagName:\
    \ \"Klaviyo - Conversion\",\n         variables: ['dlv - Variable 1', 'dlv - Variable\
    \ 2'],\n  }, {\n      eventId: 7,\n      channel: 'snapchat',\n        tagName:\
    \ \"Snapchat - Conversion\",\n         variables: ['dlv - Variable 1'],\n  }];\n\
    \  \n  // Call runCode to run the template's code.\n  runCode(mockData);\n  \n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertThat(logs).hasLength(6);\n\
    \  assertThat(logs[0]).contains(elevar_gtm_tag_info[0].tagName);\n  assertThat(logs[1]).contains(elevar_gtm_tag_info[1].tagName);\n\
    \  assertThat(logs[2]).contains(elevar_gtm_tag_info[2].tagName);\n  assertThat(logs[3]).contains(elevar_gtm_tag_info[0].tagName);\n\
    \  assertThat(logs[4]).contains(elevar_gtm_tag_info[1].tagName);\n  assertThat(logs[5]).contains('');"
- name: PIXEL // Use error eventName if provided
  code: |
    elevar_gtm_errors = [{
      eventId: 7,
      eventName: "Custom Event Name",
      dataLayerKey: 'key',
      variableName: 'dlv - Variable 1',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }, {
      eventId: 11,
      dataLayerKey: 'key',
      variableName: 'dlv - Variable 1',
      error: {
        message: 'message',
        value: 'val',
        condition: 'condition',
        conditionValue: 'conditionValue'
      }
    }];

    elevar_gtm_tag_info = [];

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertThat(logs).hasLength(2);
    assertThat(logs[0]).contains(elevar_gtm_errors[0].eventName);
    assertThat(logs[1]).contains("gtm.load");
- name: GENERAL // Debug mode
  code: |-
    mockData.debugMode = false;

    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('log').wasNotCalled();
    assertThat(logs.length === 0).isTrue();
setup: "const log = require(\"logToConsole\");\n\nconst logs = [];\n\nlet mockData\
  \ = {\n  customDataLayer: false,\n  dataLayerName: \"dataLayer\",\n  debugMode:\
  \ true\n};\n\nlet dataLayer = [\n  {\n    event: \"gtm.dom\",\n    \"gtm.uniqueEventId\"\
  : 3\n  },\n  {\n    \"gtm.start\": 1578412516211,\n    event: \"gtm.js\",\n    \"\
  gtm.uniqueEventId\": 4\n  },\n  {\n    \"gtm.start\": 1578412516344,\n    event:\
  \ \"gtm.js\",\n    \"gtm.uniqueEventId\": 7\n  },\n  {\n    event: \"gtm.load\"\
  ,\n    \"gtm.uniqueEventId\": 11\n  }\n];\n\nlet elevar_gtm_errors = [\n  {\n  \
  \  eventId: 7,\n    dataLayerKey: \"key1\",\n    variableName: \"dlv - Variable\
  \ 1\",\n    error: {\n      message: \"message1\",\n      value: \"val1\",\n   \
  \   condition: \"condition1\",\n      conditionValue: \"conditionValue1\"\n    }\n\
  \  },\n  {\n    eventId: 11,\n    dataLayerKey: \"key2\",\n    variableName: \"\
  dlv - Variable 2\",\n    error: {\n      message: \"message2\",\n      value: \"\
  val2\",\n      condition: \"condition2\",\n      conditionValue: \"conditionValue2\"\
  \n    }\n  },\n  {\n    eventId: 11,\n    dataLayerKey: \"key3\",\n    variableName:\
  \ \"dlv - Variable 3\",\n    error: {\n      message: \"message3\",\n      value:\
  \ \"val3\",\n      condition: \"condition3\",\n      conditionValue: \"conditionValue3\"\
  \n    }\n  }\n];\n\nlet elevar_gtm_tag_info = [\n  {\n    eventId: 7,\n    channel:\
  \ \"facebook\",\n    tagName: \"Facebook - Initiate Checkout\",\n    variables:\
  \ [\"dlv - Variable 1\", \"dlv - Variable 2\"]\n  },\n  {\n    eventId: 11,\n  \
  \  tagName: \"Facebook - Add To Cart\",\n    variables: [\"dlv - Variable 2\"]\n\
  \  }\n];\n\nmock(\"copyFromWindow\", variableName => {\n  switch (variableName)\
  \ {\n    case \"elevar_gtm_errors\":\n      return elevar_gtm_errors;\n    case\
  \ \"elevar_gtm_tag_info\":\n      return elevar_gtm_tag_info;\n    case mockData.dataLayerName:\n\
  \      return dataLayer;\n    default:\n      log(\"no object in mock window for\
  \ variableName: \", variableName);\n  }\n});\n\nmock(\"addEventCallback\", callback\
  \ => {\n  callback(\"GTM-12345678\");\n});\n\nmock(\"logToConsole\", msg => {\n\
  \  logs.push(msg);\n});\n\n\nmock(\"getUrl\", () => {\n\treturn 'https://test.example.com/test-page/item?id=123&s=testing';\n\
  });\n\n"


___NOTES___

Created on 04/12/2019, 13:17:50


